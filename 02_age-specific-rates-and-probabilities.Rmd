# Age-specific rates and probabilities

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
library(ggplot2)
library(HMDHFDplus)
library(keyring)
library(scales)
library(tidyverse)
```

For most human populations, demographic rates vary strongly by age.

```{r load_hmd_asr, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
# Functions to download a specified dataset item for a single county
read_hmd_country <- function(CNTRY, item) {
  HMDHFDplus::readHMDweb(
    CNTRY = CNTRY,
    item = item,
    username = keyring::key_list("human-mortality-database")$username,
    password = keyring::key_get(
      service = "human-mortality-database",
      username = keyring::key_list("human-mortality-database")$username
    )
  )
}
read_hfd_country <- function(CNTRY, item) {
  HMDHFDplus::readHFDweb(
    CNTRY = CNTRY,
    item = item,
    username = keyring::key_list("human-fertility-database")$username,
    password = keyring::key_get(
      service = "human-fertility-database",
      username = keyring::key_list("human-fertility-database")$username
    )
  )
}

# Help function to list the available countries
countries_hmd <- HMDHFDplus::getHMDcountries()
countries_hfd <- HMDHFDplus::getHFDcountries()

# Download a dataset iteratively for all countries using purrr::map()
# In this case, age-specific mortality in 1-year periods x 1-year age groups
# for all 1-year periods available
mx_1x1 <- countries_hmd %>%
  # Returns a list of data.frames, adding a column for country code to each
  purrr::map(function(country) {
    read_hmd_country(country, "Mx_1x1") %>%
      dplyr::mutate(country = country)
  }) %>%
  # Combines the data.frames into a single data.frame
  dplyr::bind_rows() %>%
  dplyr::filter(Year == 2020, Age <= 90)
number_hmd_countries <- mx_1x1 %>%
  dplyr::distinct(country) %>%
  dplyr::pull(country) %>%
  length()

# Repeat for asfr
asfr <- countries_hfd %>%
  # Returns a list of data.frames, adding a column for country code to each
  purrr::map(function(country) {
    read_hfd_country(country, "asfrRR") %>%
      dplyr::mutate(country = country)
  }) %>%
  # Combines the data.frames into a single data.frame
  dplyr::bind_rows() %>%
  dplyr::filter(Year == 2019)
number_hfd_countries <- asfr %>%
  dplyr::distinct(country) %>%
  dplyr::pull(country) %>%
  length()
```

Below is the **age pattern of mortality** from ages 0 to 90 in `r number_hmd_countries` countries in 2020^[From the Human Mortality Database: https://www.mortality.org/]

```{r hmd_asmr_plot_by_country, echo=FALSE, message=FALSE, warning=FALSE}
mx_1x1 %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = Age, y = Total, group = country) +
  ggplot2::geom_line() +
  ggplot2::scale_y_continuous(
    trans = log_trans(),
    breaks = scales::trans_breaks("log", function(x) exp(x)),
    labels = scales::trans_format("log", math_format(e^.x))
  ) +
  ggplot2::xlab("1-year age group") +
  ggplot2::ylab("Period\nage-specific\nmortality rate\n(log-scale)") +
  ggplot2::theme_minimal() +
  ggplot2::theme(panel.grid = element_blank(),
                 axis.title.y = element_text(angle = 0))
```
Now look at the **age pattern of fertility** from ages 12 to 55 in `r number_hfd_countries` countries in 2019^[From the Human Fertility Database: https://www.humanfertility.org/]

```{r hmd_asfr_plot_by_country, echo=FALSE, message=FALSE, warning=FALSE}
asfr %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = Age, y = ASFR, group = country) +
  ggplot2::geom_line() +
  ggplot2::xlab("1-year age group") +
  ggplot2::ylab("Period\nage-specific\nfertility rate") +
  ggplot2::theme_minimal() +
  ggplot2::theme(panel.grid = element_blank(),
                 axis.title.y = element_text(angle = 0))
```

## Period age-specific rates

General definition of an age-specific rate^[OMG I hate this notation!]:

$$
{}_{n}R_{x}[0,T] = \frac{
  \textsf{Number of occurrences in the age range } x \textsf{ to } x + n \textsf{ between time } 0 \textsf{ and } T
}{
  \textsf{Number of person-years lived in the age range } x \textsf{ to } x + n \textsf{ between time } 0 \textsf{ and } T
}
$$

* Mortality pattern plot above shows **age-specific mortality rates** ${}_{n}M_{x}[0,T]$
* Birth pattern plot above shows **age-specific fertility rates** ${}_{n}F_{x}[0,T]$
* Interval length $n$ given in *exact years*
    * **Example:** ${}_{5}M_{30}[0,T]$ is mortality rate between exact ages $30.\overline{0000}$ and $34.\overline{9999}$
    
### Crude rates as a function of age-specific rates and age structure {.unnumbered}

Consider crude death rate $CDR[0,T] = D/N$ measured from death counts $D$ and population size $N$^[Estimate of person-years]:

$$
\begin{align}
CDR &= \frac{D}{N}
     = \frac{\sum_{x=0}^{\infty} {}_{n}D_{x}}{N}
     = \frac{\sum_{x=0}^{\infty} \frac{{}_{n}D_{x}}{{}_{n}N_{x}}{}_{n}N_{x}}{N} \\
    &= \sum_{x=0}^{\infty} \frac{{}_{n}D_{x}}{{}_{n}N_{x}} \cdot \frac{{}_{n}N_{x}}{N} \\
    &= \sum_{x=0}^{\infty} {}_{n}M_{x}\cdot {}_{n}C_{x} \\
    &= \textsf{Sum over age groups of }
       \begin{pmatrix}
        \textsf{Age-specific} \\
        \textsf{mortality rate}
       \end{pmatrix}
       \times \begin{pmatrix}
        \textsf{Proportion in} \\
        \textsf{age group}
       \end{pmatrix}
\end{align}
$$

* ${}_{n}C_{x} = {}_{n}N_{x} / N$ is proportion aged $x$ to $x+n$
* $\sum_{x=0}^\infty {}_{n}C_{x} = 1$
* The collection of these proportions is the population's **age structure**
* In practice, you sum up to the oldest age group in the population
* WIth age intervals of inequal length, you can index age groups by $i$:

$$CDR = \sum_{i}^{\infty} M_{i}\cdot C_{i}$$

This fact can resolve paradoxical cross-spatial and cross-temporal comparisons.

**FOR EXAMPLE**

```{r us_asmr_paradox_setup, echo=FALSE, message=FALSE, warning=FALSE}
deaths <- read_hmd_country("USA", "Deaths_1x1") %>%
  dplyr::rename(Deaths = Female) %>%
  dplyr::select(Year, Age, Deaths) %>%
  dplyr::filter(Year %in% c(1933, 2019))
exposures <- read_hmd_country("USA", "Exposures_1x1") %>%
  dplyr::rename(Exposures = Female) %>%
  dplyr::select(Year, Age, Exposures) %>%
  dplyr::filter(Year %in% c(1933, 2019))
asmr_us <- deaths %>%
  dplyr::inner_join(exposures) %>%
  dplyr::mutate(m = Deaths / Exposures) %>%
  dplyr::group_by(Year) %>%
  dplyr::mutate(p = Exposures / sum(Exposures)) %>%
  dplyr::ungroup()
cdr_us <- asmr_us %>%
  dplyr::group_by(Year) %>%
  dplyr::summarize(cdr = sum(m * p)) %>%
  dplyr::ungroup() %>%
  dplyr::select(Year, cdr)
```

Below are the crude death rates in the U.S. for women in 1933 vs. 2019^[Again calculated from the Human Mortality Database]. CDR is higher in 1933. Makes sense. But 1933 was the height of the Great Depression. I'd expect a bigger gap. WTF?

```{r us_asmr_paradox_cdrs, echo=FALSE, message=FALSE, warning=FALSE}
DT::datatable(
  dplyr::mutate(cdr_us, cdr = round(1000 * cdr, 1)),
  rownames = FALSE,
  colnames = c("Year", "CDR per 1000 women"),
  options = list(dom = "T", ordering = FALSE),
  width = "50%"
)
```
<br><br>

Below are age-specific mortality rates for women in the U.S. in 1933 vs. 2019^[Again calculated from the Human Mortality Database]. Mortality was *up to an order of magnitude higher* in 1933 than 2019 at nearly all ages. Again, WTF is up with CDR comparison?

```{r us_asmr_paradox_asmr, echo=FALSE, message=FALSE, warning=FALSE}
ggplot2::ggplot(asmr_us) +
  ggplot2::geom_line(aes(x = Age, y = m, color = factor(Year))) +
  ggplot2::annotate(
    "text",
    x = 15,
    y = exp(-5),
    label = "1933",
    color = "#F8766D"
  ) +
  ggplot2::annotate(
    "text",
    x = 30,
    y = exp(-8),
    label = "2019",
    color = "#00BFC4"
  ) +
  ggplot2::scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", math_format(10^.x))
  ) +
  ggplot2::xlab("1-year age group") +
  ggplot2::ylab("Period\nage-specific\nmortality rate\n(log-scale)") +
  ggplot2::theme_minimal() +
  ggplot2::theme(panel.grid = element_blank(),
                 axis.title.y = element_text(angle = 0),
                 legend.position = "none")
```
<br><br>

But remember: $CDR = \sum_{x=0}^{\infty} {}_{n}M_{x}\cdot {}_{n}C_{x}$. Below are the the age structures for women in the U.S. in 1933 vs. 2019^[Again calculated from the Human Mortality Database]. The population was older in 2019. Mortality is higher at older ages. This could explain things.

```{r us_asmr_paradox_c, echo=FALSE, message=FALSE, warning=FALSE}
ggplot2::ggplot(asmr_us) +
  ggplot2::geom_line(aes(x = Age, y = p, color = factor(Year))) +
  ggplot2::annotate(
    "text",
    x = 30,
    y = 0.0175,
    label = "1933",
    color = "#F8766D"
  ) +
  ggplot2::annotate(
    "text",
    x = 60,
    y = 0.0145,
    label = "2019",
    color = "#00BFC4"
  ) +
  ggplot2::scale_y_continuous(labels = scales::percent) +
  ggplot2::xlab("1-year age group") +
  ggplot2::ylab("Proportion in\nage group") +
  ggplot2::theme_minimal() +
  ggplot2::theme(panel.grid = element_blank(),
                 axis.title.y = element_text(angle = 0),
                 legend.position = "none")
```

## Age-standardization

```{r ascdr_setup, echo=FALSE, message=FALSE, warning=FALSE}
pavg <- asmr_us %>%
  dplyr::group_by(Age) %>%
  dplyr::summarize(p_avg = mean(p)) %>%
  dplyr::ungroup()
p2019 <- asmr_us %>%
  dplyr::filter(Year == 2019) %>%
  dplyr::select(Age, p) %>%
  dplyr::rename(p_2019 = p)
p1933 <- asmr_us %>%
  dplyr::filter(Year == 1933) %>%
  dplyr::select(Age, p) %>%
  dplyr::rename(p_1933 = p)
asmr_standards <- asmr_us %>%
  dplyr::left_join(p2019) %>%
  dplyr::left_join(p1933) %>%
  dplyr::left_join(pavg) %>%
  dplyr::mutate(mp_s2019 = m * p_2019,
                mp_s1933 = m * p_1933,
                mp_savg = m * p_avg)
ascdr <- asmr_standards %>%
  dplyr::group_by(Year) %>%
  dplyr::summarize_at(vars(mp_s2019, mp_s1933, mp_savg), sum) %>%
  dplyr::ungroup()
```

Population aging distorts crude death rate comparisons

**Question:** How can we eliminate the effect of age distribution?

**Answer:** Age-standardized rates!

**Example:** Assume that 1933 instead had a 2019 age structure:^[This is what they call a "counterfactual" in causal inference!]

$$CDR^* = \sum_i M_i^{1933} \cdot C_i^{2019}$$

**Question:** Why not use 1933 as the standard? Or the average of $C_i$ between 1933 and 2019?

**Answer:** The choice between 1933 and 2019 is arbitrary, but can largely impact the comparison. Arguably better to average across age distributions. But be careful that one extreme age distribution isn't skewing the average

**Example:** Below are standardized and un-standardized CDRs for women in the U.S. in 1933 vs. 2019. CDR difference is smaller for older 2019 standard than younger 1933 standard. Difference is in between those values for mean of 2019 and 1933 age structures. All standardized differences are much larger than the un-standardized difference.

```{r ascdr_comparison_us, echo=FALSE, warning=FALSE, message=FALSE}
ascdr_diffs <- ascdr %>%
  dplyr::mutate_at(
    vars(starts_with("mp")),
    ~(. - dplyr::lead(.))
  ) %>%
  dplyr::filter(!is.na(mp_s2019)) %>%
  dplyr::select(starts_with("mp")) %>%
  dplyr::mutate(field = "Difference")
sketch <- htmltools::withTags(table(
  class = "display",
  thead(
    tr(
      th(rowspan = 3, ""),
      th(colspan = 4, "CDR estimates per 1000 women")
    ),
    tr(
      th(colspan = 3, "Age structure standard"),
      th(rowspan = 2, "Un-standardized")
    ),
    tr(
      th("1933"),
      th("2019"),
      th("Average")
    )
  )
))
ascdr %>%
  dplyr::rename(field = Year) %>%
  dplyr::mutate(field = as.character(field)) %>%
  dplyr::bind_rows(ascdr_diffs) %>%
  dplyr::bind_cols(tibble::tibble(
    m = c(cdr_us$cdr, cdr_us$cdr[1] - cdr_us$cdr[2])
  )) %>%
  dplyr::mutate_at(vars(starts_with("m")), ~(1000 * .)) %>%
  DT::datatable(
    container = sketch,
    rownames = FALSE,
    options = list(dom = "t", ordering = FALSE)
  ) %>%
  DT::formatStyle(columns = 1, fontWeight = "bold") %>%
  DT::formatRound(columns = 2:5, digits = 1)
```
<br>

More generally, for any standard population $s$ and focal population $j$, the **age-standardized crude death rate** (ASCDR):

$$ASCDR^j = \sum_i M_i^{s} \cdot C_i^{j}$$
Even more generally, for any rate $R$ and schedule of age-specific rates $R_i$:

$$ASR^j = \sum_i R_i^{s} \cdot C_i^{j}$$

## Decomposition of differences between rates or proportions

As a demographer or data scientist, you'll get these questions a lot:

* **Demography:** "How much of the difference between these death rates is due to differences in age distributions?"
* **People analytics:** "How much of the difference between these turnover rates is due to different tenure distributions?"
* **Marketing:** "How much of the customer conversion rate between these two lead generating websites is due to a difference in marketing channel?"

One way to answer such questions is with a clever difference decomposition.

**Example:** Crude death rate difference

$$
\Delta = CDR^B - CDR^A = \sum_i C_i^B \cdot M_i^B - \sum_i C_i^A \cdot M_i^A
$$
On pg. 28, PHG derive a useful decomposition of this difference:

$$\begin{align}
\Delta &= \sum_i \left(C_i^B-C_i^A\right) \cdot \left[\frac{M_i^B-M_i^A}{2}\right] + \sum_i \left(M_i^B-M_i^A\right) \cdot \left[\frac{C_i^B+C_i^A}{2}\right] \\
       &= \begin{pmatrix}
        \textsf{difference in age} \\
        \textsf{composition}
       \end{pmatrix}
       \cdot \begin{pmatrix}
        \textsf{weighted by avg} \\
        \textsf{age-specific mortality}
       \end{pmatrix} \\
      &+ \begin{pmatrix}
        \textsf{difference in} \\
        \text{rate schedules}
       \end{pmatrix}
       \cdot \begin{pmatrix}
        \textsf{weighted by} \\
        \textsf{average age} \\
        \textsf{composition}
       \end{pmatrix}
\end{align}
$$

Or, put even more simply:

$$
\Delta = \begin{pmatrix}
  \textsf{contribution of} \\
    \textsf{age composition} \\
    \textsf{differences to } \Delta
  \end{pmatrix}
  + \begin{pmatrix} \\
    \textsf{contribution of} \\
    \textsf{rate schedule} \\
    \textsf{differences to } \Delta
  \end{pmatrix}
$$

**Example:** Decomposing the difference in U.S. women's mortality between 1933 vs. 2019. Below is a table of period age-specific population proportions $C_i^\textsf{year}$ and mortality rates $M_i^\textsf{year}$, as well as difference contributions $\left(C_i^{1933}-C_i^{2019}\right) \cdot \left(M_i^{1933}-M_i^{2019}\right)/2$ and $\left(M_i^{1933}-M_i^{2019}\right) \cdot \left(C_i^{1933}-C_i^{2019}\right)/2$.

```{r cdr_us_decomposition_setup, echo=FALSE, message=FALSE, warning=FALSE}
contribs <- asmr_us %>%
  dplyr::select(Year, Age, m, p) %>%
  tidyr::pivot_wider(
    id_cols = Age,
    names_from = Year,
    values_from = c(m, p)
  ) %>%
  dplyr::mutate(
    p_contrib = 0.5 * (p_1933 - p_2019) * (m_1933 + m_2019),
    m_contrib = 0.5 * (m_1933 - m_2019) * (p_1933 + p_2019)
  ) %>%
  dplyr::select(
    Age,
    p_1933, p_2019,
    m_1933, m_2019,
    p_contrib, m_contrib
  )
sum_contribs <- contribs %>%
  dplyr::summarize_all(sum) %>%
  dplyr::select(ends_with("contrib"))
sketch <- htmltools::withTags(table(
  class = "display",
  thead(
    tr(
      th(rowspan = 2, "Age"),
      th(colspan = 2, "Proportion in population"),
      th(colspan = 2, "Mortality rate"),
      th(colspan = 2, "Contribution to difference")
    ),
    tr(
      lapply(rep(c("1933", "2019"), 2), th),
      lapply(rep(c("Age structure", "Rate schedule"), 1), th)
    )
  )
))
DT::datatable(
  contribs,
  container = sketch,
  rownames = FALSE,
  options = list(scrollX = TRUE, dom = "lpt", ordering = FALSE)
) %>%
  DT::formatRound(columns = 2:5, digits = 4) %>%
  DT::formatRound(columns = 6:7, digits = 6)
```

Summing up the contribution columns across age groups yields their total contribution^[This is a good example of how looking at the code for this book chapter in GitHub can help you with your problem sets.].

* Age structure contribution is negative because 1933 population is younger
* Rate schedule contribution is positive because 1933 mortality was higher

```{r cdr_us_decomposition, echo=FALSE, warning=FALSE, message=FALSE}
sketch <- htmltools::withTags(table(
  class = "display",
  thead(
    tr(
      th(colspan = 2, "Total contribution to difference by...")
    ),
    tr(
      th("Age structure"),
      th("Rate schedule")
    )
  )
))
sum_contribs %>%
  dplyr::mutate_all(~(. * 1000)) %>%
  DT::datatable(
    caption = "Figures per 1000 women",
    container = sketch,
    rownames = FALSE,
    options = list(scrollX = TRUE, dom = "t", ordering = FALSE),
    width = "50%"
  ) %>%
  DT::formatRound(columns = 1:2, digits = 1)
```
<br>

 The sum of these contributions yields back the original difference:

$$\Delta = CDR^{1933} - CDR^{2019} = `r round(sum(1000 * as.numeric(sum_contribs)), 1)` \textsf{ per 1000 women}$$

## The Lexis diagram

## Age-specific probabilities

:::{.rmdtip}
**DEMOGRAPHY & DATA SCIENCE**

### More corporate confusion, tenure-specific rates vs. probabilities edition
:::

## Probabilities of death based on mortality experience of a single calendar year

:::{.rmdtip}
**DEMOGRAPHY & DATA SCIENCE**

### Funky new hire turnover metrics and how to avoid them
:::
